<!DOCTYPE html>
<html lang="en">
<head>
  <meta charSet="utf-8">
  <title>DP100 WebApp</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="assets/icons/icon512_rounded.png" type="image/png">
  <link href="https://cdn.jsdelivr.net/npm/uplot@1.6.31/dist/uPlot.min.css" rel="stylesheet">
  <style>
    :root {
      color-scheme: light dark;
    }

    body {
      color: CanvasText;
      background-color: Canvas;
      margin: 0;
    }

    .u-value {
      font-family: monospace;
      vertical-align: bottom;
    }

    button#connect {
      position: absolute;
      top: 1rem;
      left: 6rem;
      z-index: 10;
    }
  </style>
</head>
<body>
<button id="connect">connect</button>
<script type="module">
  import uplot from 'https://cdn.jsdelivr.net/npm/uplot@1.6.31/+esm'

  const dark = window.matchMedia('(prefers-color-scheme: dark)').matches
  const vendorId = 11836, productId = 44801  // DP100's HID IDs
  const deviceAddr = 251  // DP100's device address

  /**
   * Calculate the buffers CRC-16/MODBUS checksum.
   *
   * @param {ArrayBuffer} buffer - The buffer to calculate the CRC16 for.
   * @return {number} - The CRC16 checksum.
   */
  function crc16 (buffer) {
    let crc = 0xFFFF

    for (const byte of new Uint8Array(buffer)) {
      crc = crc ^ byte

      for (let j = 0; j < 8; j++) {
        const odd = crc & 0x0001
        crc = crc >> 1
        if (odd) {
          crc = crc ^ 0xA001
        }
      }
    }

    return crc
  }

  /** DP100 Modbus Function IDs */
  const FUNCTIONS = Object.freeze({
    DEVICE_INFO: 0x10,
    FIRM_INFO: 17,
    START_TRANS: 18,
    DATA_TRANS: 19,
    END_TRANS: 20,
    DEV_UPGRADE: 21,
    BASIC_INFO: 48,
    BASIC_SET: 53,
    SYSTEM_INFO: 0x40,
    SYSTEM_SET: 69,
    SCAN_OUT: 80,
    SERIAL_OUT: 85,
    DISCONNECT: 0x80,
    NONE: 0xFF,
  })

  const WORK_MODES = Object.freeze({
    CC: 0,
    CV: 1,
    OFF: 2,
  })

  const WORK_MODE_MAP = {
    [WORK_MODES.CV]: 'Constant Voltage',
    [WORK_MODES.CC]: 'Constant Current',
    [WORK_MODES.OFF]: 'Off',
  }

  /** DP100 device class.
   *
   * This class is used to interact with the DP100 power supply.
   * @example
   *
   * class MyPSU extends DP100 {
   *   receiveBasicInfo ({vIn, vOut, iOut, voMax, temp1, temp2, dc5V, outMode, workSt}) {
   *     console.info('Input Voltage:', vIn, 'V')
   *     console.info('Output Voltage:', vOut, 'V')
   *     console.info('Output Current:', iOut, 'A')
   *     console.info('Max Output Voltage:', voMax, 'V')
   *     console.info('Temperature 1:', temp1, '째C')
   *     console.info('Temperature 2:', temp2, '째C')
   *     console.info('DC 5V:', dc5V, 'V')
   *     console.info('Output Mode:', WORK_MODE_MAP[outMode])
   *     console.info('Work State:', workSt)
   *   }
   * }
   *
   * const psu = new MyPSU()
   * await psu.connect()
   */
  class DP100 {

    device = null

    /** Connect to the DP100 device. */
    async connect () {
      [this.device] = await navigator.hid.requestDevice({
        filters: [{ vendorId, productId }]
      })
      await this.device.open()
      this.device.addEventListener('inputreport', this.inputReportHandler.bind(this))
      setInterval(
        () => this.sendReport(FUNCTIONS.BASIC_INFO), 10
      )
    }

    /** Send a report to the DP100
     * @param {Number} functionId -- The function to call on the DP100.
     * @param {Uint8Array} content -- The data to send to the DP100.
     */
    async sendReport (functionId, content = null) {
      content = content || new Uint8Array(0)
      const report = new Uint8Array([
        deviceAddr,
        functionId,
        content.length,
        content,
        0, // checksum
        0  // checksum
      ])
      const reportView = new DataView(report.buffer, report.byteOffset, report.byteLength)
      const checksum = crc16(report.buffer.slice(0, report.length - 2))
      reportView.setUint16(report.length - 2, checksum, true)
      console.debug('device.sendReport', reportView)
      return this.device.sendReport(0, report)
    }

    /** Handle input reports from the DP100
     * @param {HIDInputReportEvent} event
     */
    inputReportHandler (event) {
      console.debug('device.inputreport', event)
      const data = event.data
      const headerLength = 4
      const header = {
        deviceAddr: data.getUint8(0),
        functionType: event.data.getUint8(1),
        sequence: event.data.getUint8(2),
        contentLength: event.data.getUint8(3),
      }
      const contentView = new DataView(data.buffer.slice(headerLength, headerLength + header.contentLength))
      const checksum = data.getUint16(headerLength + header.contentLength, true)
      const computedChecksum = crc16(data.buffer.slice(0, headerLength + header.contentLength))
      if (computedChecksum !== checksum) {
        console.error('Checksum Failed', {
          expected: computedChecksum.toString(16),
          received: checksum.toString(16)
        })
        return
      }
      console.debug('content', contentView)

      switch (header.functionType) {
        case FUNCTIONS.BASIC_INFO:
          const basicInfo = {
            vIn: contentView.getUint16(0, true) / 1000,
            vOut: contentView.getUint16(2, true) / 1000,
            iOut: contentView.getUint16(4, true) / 1000,
            voMax: contentView.getUint16(6, true) / 1000,
            temp1: contentView.getUint16(8, true) / 10,
            temp2: contentView.getUint16(10, true) / 10,
            dc5V: contentView.getUint16(12, true) / 1000,
            outMode: contentView.getUint8(14),
            workSt: contentView.getUint8(15)
          }
          this.receiveBasicInfo(basicInfo)
          break
        default:
          console.warn('Unhandled function', header.functionType)
      }
    }

    /** Handle basic info from the DP100
     * @param {Object} basicInfo
     * @param {Number} basicInfo.vIn - Input voltage in mV.
     * @param {Number} basicInfo.vOut - Output voltage in mV.
     * @param {Number} basicInfo.iOut - Output current in mA.
     * @param {Number} basicInfo.voMax - Max output voltage in mV.
     * @param {Number} basicInfo.temp1 - Temperature 1 in 0.1째C.
     * @param {Number} basicInfo.temp2 - Temperature 2 in 0.1째C.
     * @param {Number} basicInfo.dc5V - 5V rail in mV.
     * @param {Number} basicInfo.outMode - Output mode.
     * @param {Number} basicInfo.workSt - Work state.
     */
    receiveBasicInfo ({ vIn, vOut, iOut, voMax, temp1, temp2, dc5V, outMode, workSt }) {
      const BasicInfoEvent = new CustomEvent('basicInfo', {
        detail: { vIn, vOut, iOut, voMax, temp1, temp2, dc5V, outMode, workSt }
      })
      document.dispatchEvent(BasicInfoEvent)
    }
  }

  let opts = {
    id: 'uv-graph',
    width: window.innerWidth,
    height: window.innerHeight - 32,
    series: [
      {
        label: 'Time',
        value: (self, rawValue) => rawValue === null ? '   N/A' : new Date(rawValue * 1000).toLocaleTimeString(),
      },
      {
        show: true,
        spanGaps: true,
        label: 'Voltage',
        value: (self, rawValue) => rawValue === null ? 'N/A' : rawValue.toLocaleString(undefined, { minimumFractionDigits: 3 }) + 'V',
        scale: 'V',
        stroke: 'rgb(250, 200, 0)',
        width: 2,
      }, {
        show: true,
        spanGaps: true,
        label: 'Current',
        value: (self, rawValue) => rawValue === null ? 'N/A' : rawValue.toLocaleString(undefined, { minimumFractionDigits: 3 }) + 'A',
        scale: 'A',
        stroke: 'green',
        width: 2,
      }, {
        show: true,
        spanGaps: true,
        label: 'Power',
        value: (self, rawValue) => rawValue === null ? 'N/A' : rawValue.toLocaleString(undefined, { minimumFractionDigits: 3 }) + 'W',
        scale: 'W',
        fill: 'rgba(200, 0, 200, 0.3)',
        width: 0,
      }
    ],
    axes: [
      {
        show: false
      },
      {
        scale: 'V',
        label: 'Voltage (V)',
        value: (self, rawValue) => rawValue === null ? 'N/A' : rawValue.toLocaleString(undefined, { minimumFractionDigits: 3 }) + 'V',
        grid: { show: false },
        stroke: () => dark ? 'white' : 'black',
        ticks: {
          stroke: () => dark ? 'white' : 'black',
        },
      },
      {
        scale: 'A',
        label: 'Current (A)',
        value: (self, rawValue) => rawValue === null ? 'N/A' : rawValue.toLocaleString(undefined, { minimumFractionDigits: 3 }) + 'A',
        side: 1,
        grid: { show: false },
        stroke: () => dark ? 'white' : 'black',
        ticks: {
          stroke: () => dark ? 'white' : 'black',
        },
      },
      {},
    ],
    scales: {
      'x': {},
      'V': {
        auto: false,
        range: [0, 30],
      },
      'A': {
        auto: false,
        range: [0, 5],
      },
      'W': {
        auto: false,
        range: [0, 100],
      }
    },
  }

  const tHistory = []
  const vHistory = []
  const iHistory = []
  const wHistory = []
  const data = [tHistory, vHistory, iHistory, wHistory]

  const graph = new uplot(opts, data, document.body)

  document.querySelector('button').addEventListener('click', async () => {
    const dp100 = new DP100()
    await dp100.connect()

    document.addEventListener('basicInfo', (event) => {
      const { vOut, iOut } = event.detail
      tHistory.push(Date.now() / 1000)
      vHistory.push(vOut)
      iHistory.push(iOut)
      wHistory.push(vOut * iOut)
      if (vHistory.length > 1200) {
        tHistory.shift()
        vHistory.shift()
        iHistory.shift()
        wHistory.shift()
      }
      graph.setData(data)
    })

  })
</script>
</body>
</html>